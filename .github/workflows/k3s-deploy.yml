name: Docker â†’ k3s Deploy (Bullet 4)
on:
  push:
    paths:
      - 'Dockerfile'
      - 'app.js'
      - 'package.json'
      - 'k8s/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build and save Docker
      run: |
        docker build -t todo-api:${{ github.sha }} .
        docker save todo-api:${{ github.sha }} | gzip > app.tar.gz
    
    - name: Copy to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        source: "app.tar.gz,k8s/*"
        target: "/home/ec2-user/todo-api"
    
    - name: Deploy to k3s
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          cd /home/ec2-user/todo-api
          docker load < app.tar.gz
          kubectl apply -f k8s/
          kubectl rollout status deployment/todo-api --timeout=300s
          kubectl get svc todo-api-service
